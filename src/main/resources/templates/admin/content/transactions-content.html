<!-- Transactions List -->
<div x-data="transactionsPage()" x-init="init()">
    <div class="max-w-7xl mx-auto py-6 px-4">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-semibold text-gray-900">Transactions</h1>
                <nav class="text-sm text-gray-500 mt-1">
                    <span>Home</span>
                    <span class="mx-2">›</span>
                    <span>Bank</span>
                    <span class="mx-2">›</span>
                    <span class="text-gray-700">Transactions</span>
                </nav>
            </div>
            <a href="/admin/transactions/new" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-plus mr-2"></i>
                Add Transaction
            </a>
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.type">
                    <option value="">type</option>
                    <option value="CREDIT">Credit</option>
                    <option value="DEBIT">Debit</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.channel">
                    <option value="">channel</option>
                    <option value="TRANSFER">Transfer</option>
                    <option value="DEPOSIT">Deposit</option>
                    <option value="BILL">Bill Payment</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.status">
                    <option value="">status</option>
                    <option value="SUCCESS">Success</option>
                    <option value="PENDING">Pending</option>
                    <option value="FAILED">Failed</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.currency">
                    <option value="">currency</option>
                    <option value="NGN">NGN</option>
                    <option value="USD">USD</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.hasReversal">
                    <option value="">Has Reversal</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.large">
                    <option value="">Large Transaction</option>
                    <option value="100000">≥ ₦100,000</option>
                    <option value="1000000">≥ ₦1,000,000</option>
                </select>
                <select class="border border-gray-300 rounded px-3 py-2" x-model="filters.suspicious">
                    <option value="">Suspicious Activity</option>
                    <option value="true">Flagged</option>
                    <option value="false">Not flagged</option>
                </select>
                <input type="text" placeholder="Search by reference or wallet" class="border border-gray-300 rounded px-3 py-2 lg:col-span-2" x-model.debounce.400ms="filters.q">
                <div class="flex items-center space-x-2 lg:col-span-2">
                    <select class="border border-gray-300 rounded px-3 py-2 w-full" x-model="bulkAction">
                        <option value="">----------</option>
                        <option value="export">Export Selected</option>
                        <option value="flag">Flag as Suspicious</option>
                        <option value="reverse">Reverse</option>
                        <option value="delete">Delete</option>
                        <option value="mark-successful">Mark as successful</option>
                        <option value="mark-failed">Mark as failed</option>
                        <option value="export">Export transaction data</option>
                        <option value="export-csv">Export Selected Transaction as CSV</option>
                        <option value="export-excel">Export Selected Transaction as Excel (XLSX)</option>
                        <option value="export-pdf">Export PDF Statement for Date Range</option>
                        <option value="approve">Approve selected transaction</option>
                        <option value="mark-reviewed">Mark selected as reviewed</option>
                        <option value="flag-suspicious">Flag selected as suspicious</option>
                    </select>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" @click="applyBulkAction()">Go</button>
                    <div class="text-sm text-gray-600" x-text="`${selectedIds.size} of ${transactions.length} selected`"></div>
                </div>
                <div class="flex items-center lg:col-span-1">
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" @click="loadTransactions()">Search</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3">
                            <input type="checkbox" @change="toggleSelectAll($event)">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wallet</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Channel</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance after</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Currency</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Parent Transaction</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="tx in transactions" :key="tx.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <input type="checkbox" :value="tx.id" @change="toggleSelect(tx.id, $event)" :checked="selectedIds.has(tx.id)">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">
                                <a :href="`/admin/transactions/${tx.id}`" x-text="tx.reference"></a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="tx.walletLabel"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" :class="tx.type==='DEBIT' ? 'text-red-600' : 'text-green-600'" x-text="formatAmount(tx)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" x-text="tx.type"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" x-text="tx.channel"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" :class="statusClass(tx.status)" x-text="tx.status"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="formatDate(tx.createdAt)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="formatCurrency(tx.balanceAfter, tx.currency)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="tx.currency"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700" x-text="tx.parentReference || '-' "></td>
                        </tr>
                    </template>
                    <tr x-show="transactions.length === 0">
                        <td colspan="11" class="px-6 py-6 text-center text-gray-500">No transactions found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function transactionsPage(){
            return {
                transactions: [],
                selectedIds: new Set(),
                bulkAction: '',
                filters: { type:'', channel:'', status:'', currency:'', hasReversal:'', large:'', suspicious:'', q:'' },
                async init(){ 
                    await this.testAuth();
                    await this.loadTransactions(); 
                },
                async testAuth(){
                    try {
                        const res = await fetch('/admin/api/test-auth', {
                            credentials: 'same-origin'
                        });
                        if (res.ok) {
                            const data = await res.json();
                            console.log('Auth test result:', data);
                        } else {
                            console.error('Auth test failed:', res.status, res.statusText);
                        }
                    } catch (e) {
                        console.error('Auth test error:', e);
                    }
                },
                async loadTransactions(){
                    try {
                        const params = new URLSearchParams(this.filters).toString();
                        const res = await fetch(`/admin/api/transactions?${params}`, {
                            credentials: 'same-origin' // Include cookies for authentication
                        });
                        
                        if (!res.ok) {
                            if (res.status === 401 || res.status === 403) {
                                console.error('Authentication required. Redirecting to login...');
                                window.location.href = '/login';
                                return;
                            }
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        
                        const data = await res.json();
                        this.transactions = Array.isArray(data) ? data : (data?.content || []);
                        console.log('Loaded transactions:', this.transactions.length);
                    } catch (e) { 
                        console.error('Error loading transactions:', e);
                        this.transactions = [];
                    }
                },
                toggleSelect(id, ev){ if(ev.target.checked){ this.selectedIds.add(id); } else { this.selectedIds.delete(id); } },
                toggleSelectAll(ev){ if(ev.target.checked){ this.transactions.forEach(t=>this.selectedIds.add(t.id)); } else { this.selectedIds.clear(); } },
                applyBulkAction(){ /* placeholder for future actions */ },
                statusClass(s){ return { 'SUCCESS':'bg-green-100 text-green-800', 'PENDING':'bg-yellow-100 text-yellow-800', 'FAILED':'bg-red-100 text-red-800' }[s] || 'bg-gray-100 text-gray-800'; },
                formatCurrency(a, c){ try { return new Intl.NumberFormat('en-NG', { style:'currency', currency: c || 'NGN' }).format(a || 0); } catch(_) { return a; } },
                formatAmount(tx){ const sign = tx.type==='DEBIT' ? '-' : '+'; return `${sign}${this.formatCurrency(Math.abs(tx.amount), tx.currency)}`; },
                formatDate(d){ return new Date(d).toLocaleString(); }
            }
        }
    </script>
</div>
