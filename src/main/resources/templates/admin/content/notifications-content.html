<div x-data="notificationManager()">
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-bell text-bank-blue mr-3"></i>
                    Notifications Management
                </h1>
                <p class="text-gray-600">Manage system notifications, alerts, and user communications</p>
            </div>
            <div class="flex space-x-3">
                <button @click="refreshNotifications()" 
                        class="bg-bank-blue text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
                <button @click="showCreateModal = true" 
                        class="bg-bank-green text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Create Notification
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-envelope text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Notifications</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.totalNotifications || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Unread</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.unreadCount || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-exclamation-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Urgent</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.urgentCount || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-mouse-pointer text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Actionable</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.actionableCount || 0"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Type</label>
                <select x-model="filters.type" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Types</option>
                    <option value="SYSTEM_ALERT">System Alert</option>
                    <option value="BANK_TRANSFER">Bank Transfer</option>
                    <option value="PAYMENT_SUCCESS">Payment Success</option>
                    <option value="PAYMENT_FAILED">Payment Failed</option>
                    <option value="SECURITY_ALERT">Security Alert</option>
                    <option value="PROMOTION">Promotion</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Level</label>
                <select x-model="filters.level" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Levels</option>
                    <option value="LOW">Low</option>
                    <option value="INFO">Info</option>
                    <option value="SUCCESS">Success</option>
                    <option value="WARNING">Warning</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
                <select x-model="filters.status" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="SENT">Sent</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="READ">Read</option>
                    <option value="FAILED">Failed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input x-model="filters.search" @input="applyFilters()" 
                       type="text" placeholder="Search notifications..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-list text-bank-blue mr-2"></i>
                Notifications
            </h3>
            <div class="flex space-x-2">
                <button @click="markAllAsRead()" 
                        class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    Mark All Read
                </button>
                <button @click="deleteSelected()" 
                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    Delete Selected
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" @change="toggleSelectAll()" x-model="selectAll" class="h-4 w-4 text-bank-blue">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="notification in filteredNotifications" :key="notification.id">
                        <tr class="hover:bg-gray-50" :class="{ 'bg-blue-50': !notification.isRead }">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" x-model="selectedNotifications" :value="notification.id" class="h-4 w-4 text-bank-blue">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getTypeBadgeClass(notification.type)" 
                                      x-text="notification.type"></span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <div class="flex items-center">
                                    <div x-show="!notification.isRead" class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                    <span class="font-medium" x-text="notification.title"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getLevelBadgeClass(notification.level)" 
                                      x-text="notification.level"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getStatusBadgeClass(notification.status)" 
                                      x-text="notification.status"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(notification.createdAt)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button @click="viewNotification(notification.id)" 
                                        class="text-bank-blue hover:text-blue-900 mr-3">View</button>
                                <button @click="toggleReadStatus(notification.id)" 
                                        class="text-green-600 hover:text-green-900 mr-3">
                                    <span x-text="notification.isRead ? 'Mark Unread' : 'Mark Read'"></span>
                                </button>
                                <button @click="deleteNotification(notification.id)" 
                                        class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredNotifications.length === 0">
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No notifications found
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div x-show="showCreateModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Notification</h3>
                <form @submit.prevent="createNotification()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input x-model="newNotification.title" type="text" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                            <textarea x-model="newNotification.message" required rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select x-model="newNotification.type" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="SYSTEM_ALERT">System Alert</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="PAYMENT_SUCCESS">Payment Success</option>
                                <option value="PAYMENT_FAILED">Payment Failed</option>
                                <option value="SECURITY_ALERT">Security Alert</option>
                                <option value="PROMOTION">Promotion</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text sm font-medium text-gray-700 mb-1">Level</label>
                            <select x-model="newNotification.level" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="LOW">Low</option>
                                <option value="INFO">Info</option>
                                <option value="SUCCESS">Success</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Channels</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="EMAIL" class="mr-2">
                                    <span class="text-sm">Email</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="SMS" class="mr-2">
                                    <span class="text-sm">SMS</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="PUSH" class="mr-2">
                                    <span class="text-sm">Push</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="WEBSOCKET" class="mr-2">
                                    <span class="text-sm">In-App</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showCreateModal = false" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-bank-blue text-white rounded-md hover:bg-blue-700">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function notificationManager() {
            return {
                notifications: [],
                filteredNotifications: [],
                selectedNotifications: [],
                selectAll: false,
                showCreateModal: false,
                stats: {
                    totalNotifications: 0,
                    unreadCount: 0,
                    urgentCount: 0,
                    actionableCount: 0
                },
                filters: {
                    type: '',
                    level: '',
                    status: '',
                    search: ''
                },
                newNotification: {
                    title: '',
                    message: '',
                    type: 'SYSTEM_ALERT',
                    level: 'INFO',
                    channels: []
                },
                
                init() {
                    this.loadNotifications();
                    this.loadStats();
                },
                
                async loadNotifications() {
                    try {
                        const response = await fetch('/admin/api/notifications', {
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.notifications = data.content || [];
                            this.applyFilters();
                        } else {
                            console.error('Failed to load notifications:', response.status);
                            this.createSampleNotifications();
                        }
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                        this.createSampleNotifications();
                    }
                },
                
                createSampleNotifications() {
                    this.notifications = [
                        {
                            id: 1,
                            title: 'System Maintenance Scheduled',
                            message: 'Scheduled maintenance will occur tonight from 2 AM to 4 AM.',
                            type: 'SYSTEM_ALERT',
                            level: 'INFO',
                            status: 'SENT',
                            isRead: false,
                            createdAt: new Date().toISOString(),
                            actionText: 'View Details'
                        },
                        {
                            id: 2,
                            title: 'Security Alert: Unusual Login',
                            message: 'Unusual login activity detected from new location.',
                            type: 'SECURITY_ALERT',
                            level: 'WARNING',
                            status: 'PENDING',
                            isRead: true,
                            createdAt: new Date(Date.now() - 3600000).toISOString(),
                            actionText: 'Review Activity'
                        },
                        {
                            id: 3,
                            title: 'Payment Processed Successfully',
                            message: 'Payment of â‚¦50,000 has been processed successfully.',
                            type: 'PAYMENT_SUCCESS',
                            level: 'SUCCESS',
                            status: 'DELIVERED',
                            isRead: false,
                            createdAt: new Date(Date.now() - 7200000).toISOString()
                        }
                    ];
                    this.applyFilters();
                    this.calculateStats();
                },
                
                calculateStats() {
                    this.stats.totalNotifications = this.notifications.length;
                    this.stats.unreadCount = this.notifications.filter(n => !n.isRead).length;
                    this.stats.urgentCount = this.notifications.filter(n => n.level === 'CRITICAL' || n.level === 'ERROR').length;
                    this.stats.actionableCount = this.notifications.filter(n => n.actionText).length;
                },
                
                applyFilters() {
                    this.filteredNotifications = this.notifications.filter(notification => {
                        const matchesType = !this.filters.type || notification.type === this.filters.type;
                        const matchesLevel = !this.filters.level || notification.level === this.filters.level;
                        const matchesStatus = !this.filters.status || notification.status === this.filters.status;
                        const matchesSearch = !this.filters.search || 
                            notification.title.toLowerCase().includes(this.filters.search.toLowerCase()) ||
                            notification.message.toLowerCase().includes(this.filters.search.toLowerCase());
                        
                        return matchesType && matchesLevel && matchesStatus && matchesSearch;
                    });
                },
                
                toggleSelectAll() {
                    if (this.selectAll) {
                        this.selectedNotifications = this.filteredNotifications.map(n => n.id);
                    } else {
                        this.selectedNotifications = [];
                    }
                },
                
                async createNotification() {
                    try {
                        const response = await fetch('/admin/api/notifications', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newNotification),
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.showCreateModal = false;
                            this.resetNewNotification();
                            this.loadNotifications();
                        }
                    } catch (error) {
                        console.error('Error creating notification:', error);
                    }
                },
                
                resetNewNotification() {
                    this.newNotification = {
                        title: '',
                        message: '',
                        type: 'SYSTEM_ALERT',
                        level: 'INFO',
                        channels: []
                    };
                },
                
                getTypeBadgeClass(type) {
                    const classes = {
                        'SYSTEM_ALERT': 'bg-blue-100 text-blue-800',
                        'BANK_TRANSFER': 'bg-green-100 text-green-800',
                        'PAYMENT_SUCCESS': 'bg-green-100 text-green-800',
                        'PAYMENT_FAILED': 'bg-red-100 text-red-800',
                        'SECURITY_ALERT': 'bg-red-100 text-red-800',
                        'PROMOTION': 'bg-purple-100 text-purple-800'
                    };
                    return classes[type] || 'bg-gray-100 text-gray-800';
                },
                
                getLevelBadgeClass(level) {
                    const classes = {
                        'LOW': 'bg-gray-100 text-gray-800',
                        'INFO': 'bg-blue-100 text-blue-800',
                        'SUCCESS': 'bg-green-100 text-green-800',
                        'WARNING': 'bg-yellow-100 text-yellow-800',
                        'ERROR': 'bg-red-100 text-red-800',
                        'CRITICAL': 'bg-red-200 text-red-900'
                    };
                    return classes[level] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusBadgeClass(status) {
                    const classes = {
                        'PENDING': 'bg-yellow-100 text-yellow-800',
                        'SENT': 'bg-blue-100 text-blue-800',
                        'DELIVERED': 'bg-green-100 text-green-800',
                        'READ': 'bg-gray-100 text-gray-800',
                        'FAILED': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString();
                },
                
                async loadStats() {
                    try {
                        const response = await fetch('/admin/api/notifications/stats', {
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.stats = data;
                        } else {
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error loading stats:', error);
                        this.calculateStats();
                    }
                },
                
                async markAllAsRead() {
                    try {
                        const response = await fetch('/admin/api/notifications/mark-all-read', {
                            method: 'POST',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications.forEach(n => n.isRead = true);
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error marking all as read:', error);
                    }
                },
                
                async deleteSelected() {
                    if (this.selectedNotifications.length === 0) return;
                    
                    try {
                        const response = await fetch('/admin/api/notifications/delete-selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids: this.selectedNotifications }),
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications = this.notifications.filter(n => !this.selectedNotifications.includes(n.id));
                            this.selectedNotifications = [];
                            this.selectAll = false;
                            this.applyFilters();
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error deleting notifications:', error);
                    }
                },
                
                async viewNotification(id) {
                    console.log('View notification:', id);
                },
                
                async toggleReadStatus(id) {
                    try {
                        const notification = this.notifications.find(n => n.id === id);
                        if (notification) {
                            notification.isRead = !notification.isRead;
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error toggling read status:', error);
                    }
                },
                
                async deleteNotification(id) {
                    try {
                        const response = await fetch(`/admin/api/notifications/${id}`, {
                            method: 'DELETE',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications = this.notifications.filter(n => n.id !== id);
                            this.applyFilters();
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error deleting notification:', error);
                    }
                },
                
                async refreshNotifications() {
                    await this.loadNotifications();
                    await this.loadStats();
                }
            }
        }
    </script>
</div>

