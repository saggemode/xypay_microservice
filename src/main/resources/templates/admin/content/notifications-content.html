<div x-data="notificationManager()">
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-bell text-bank-blue mr-3"></i>
                    Notifications Management
                </h1>
                <p class="text-gray-600">Manage system notifications, alerts, and user communications</p>
            </div>
            <div class="flex space-x-3">
                <button @click="refreshNotifications()" 
                        class="bg-bank-blue text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
                <button @click="showCreateModal = true" 
                        class="bg-bank-green text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Create Notification
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-envelope text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Notifications</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.totalNotifications || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Unread</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.unreadCount || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-exclamation-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Urgent</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.urgentCount || 0"></p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-mouse-pointer text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Actionable</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.actionableCount || 0"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Type</label>
                <select x-model="filters.type" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Types</option>
                    <option value="SYSTEM_ALERT">System Alert</option>
                    <option value="BANK_TRANSFER">Bank Transfer</option>
                    <option value="PAYMENT_SUCCESS">Payment Success</option>
                    <option value="PAYMENT_FAILED">Payment Failed</option>
                    <option value="SECURITY_ALERT">Security Alert</option>
                    <option value="PROMOTION">Promotion</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Level</label>
                <select x-model="filters.level" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Levels</option>
                    <option value="LOW">Low</option>
                    <option value="INFO">Info</option>
                    <option value="SUCCESS">Success</option>
                    <option value="WARNING">Warning</option>
                    <option value="ERROR">Error</option>
                    <option value="CRITICAL">Critical</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
                <select x-model="filters.status" @change="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="SENT">Sent</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="READ">Read</option>
                    <option value="FAILED">Failed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input x-model="filters.search" @input="applyFilters()" 
                       type="text" placeholder="Search notifications..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-list text-bank-blue mr-2"></i>
                Notifications
            </h3>
            <div class="flex space-x-2">
                <button @click="markAllAsRead()" 
                        class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                    Mark All Read
                </button>
                <button @click="deleteSelected()" 
                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                    Delete Selected
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" @change="toggleSelectAll()" x-model="selectAll" class="h-4 w-4 text-bank-blue">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="notification in filteredNotifications" :key="notification.id">
                        <tr class="hover:bg-gray-50" :class="{ 'bg-blue-50': !notification.isRead }">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" x-model="selectedNotifications" :value="notification.id" class="h-4 w-4 text-bank-blue">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getTypeBadgeClass(notification.type)" 
                                      x-text="notification.type"></span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <div class="flex items-center">
                                    <div x-show="!notification.isRead" class="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                                    <span class="font-medium" x-text="notification.title"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getLevelBadgeClass(notification.level)" 
                                      x-text="notification.level"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                                      :class="getStatusBadgeClass(notification.status)" 
                                      x-text="notification.status"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(notification.createdAt)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button @click="viewNotification(notification.id)" 
                                        class="text-bank-blue hover:text-blue-900 mr-3">View</button>
                                <button @click="toggleReadStatus(notification.id)" 
                                        class="text-green-600 hover:text-green-900 mr-3">
                                    <span x-text="notification.isRead ? 'Mark Unread' : 'Mark Read'"></span>
                                </button>
                                <button @click="deleteNotification(notification.id)" 
                                        class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="filteredNotifications.length === 0">
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No notifications found
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div x-show="showCreateModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Notification</h3>
                <form @submit.prevent="createNotification()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input x-model="newNotification.title" type="text" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                            <textarea x-model="newNotification.message" required rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select x-model="newNotification.type" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="SYSTEM_ALERT">System Alert</option>
                                <option value="BANK_TRANSFER">Bank Transfer</option>
                                <option value="PAYMENT_SUCCESS">Payment Success</option>
                                <option value="PAYMENT_FAILED">Payment Failed</option>
                                <option value="SECURITY_ALERT">Security Alert</option>
                                <option value="PROMOTION">Promotion</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text sm font-medium text-gray-700 mb-1">Level</label>
                            <select x-model="newNotification.level" required 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="LOW">Low</option>
                                <option value="INFO">Info</option>
                                <option value="SUCCESS">Success</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Channels</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="EMAIL" class="mr-2">
                                    <span class="text-sm">Email</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="SMS" class="mr-2">
                                    <span class="text-sm">SMS</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="PUSH" class="mr-2">
                                    <span class="text-sm">Push</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="newNotification.channels" value="WEBSOCKET" class="mr-2">
                                    <span class="text-sm">In-App</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showCreateModal = false" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-bank-blue text-white rounded-md hover:bg-blue-700">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function notificationManager() {
            return {
                notifications: [],
                filteredNotifications: [],
                selectedNotifications: [],
                selectAll: false,
                showCreateModal: false,
                stats: {
                    totalNotifications: 0,
                    unreadCount: 0,
                    urgentCount: 0,
                    actionableCount: 0
                },
                filters: {
                    type: '',
                    level: '',
                    status: '',
                    search: ''
                },
                newNotification: {
                    title: '',
                    message: '',
                    type: 'SYSTEM_ALERT',
                    level: 'INFO',
                    channels: []
                },
                
                init() {
                    this.loadNotifications();
                    this.loadStats();
                },
                
                async loadNotifications() {
                    try {
                        const response = await fetch('/admin/api/notifications', {
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.notifications = data.content || [];
                            this.applyFilters();
                        } else {
                            console.error('Failed to load notifications:', response.status);
                            this.createSampleNotifications();
                        }
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                        this.createSampleNotifications();
                    }
                },
                
                createSampleNotifications() {
                    this.notifications = [
                        {
                            id: 1,
                            title: 'System Maintenance Scheduled',
                            message: 'Scheduled maintenance will occur tonight from 2 AM to 4 AM.',
                            type: 'SYSTEM_ALERT',
                            level: 'INFO',
                            status: 'SENT',
                            isRead: false,
                            createdAt: new Date().toISOString(),
                            actionText: 'View Details'
                        },
                        {
                            id: 2,
                            title: 'Security Alert: Unusual Login',
                            message: 'Unusual login activity detected from new location.',
                            type: 'SECURITY_ALERT',
                            level: 'WARNING',
                            status: 'PENDING',
                            isRead: true,
                            createdAt: new Date(Date.now() - 3600000).toISOString(),
                            actionText: 'Review Activity'
                        },
                        {
                            id: 3,
                            title: 'Payment Processed Successfully',
                            message: 'Payment of ₦50,000 has been processed successfully.',
                            type: 'PAYMENT_SUCCESS',
                            level: 'SUCCESS',
                            status: 'DELIVERED',
                            isRead: false,
                            createdAt: new Date(Date.now() - 7200000).toISOString()
                        }
                    ];
                    this.applyFilters();
                    this.calculateStats();
                },
                
                calculateStats() {
                    this.stats.totalNotifications = this.notifications.length;
                    this.stats.unreadCount = this.notifications.filter(n => !n.isRead).length;
                    this.stats.urgentCount = this.notifications.filter(n => n.level === 'CRITICAL' || n.level === 'ERROR').length;
                    this.stats.actionableCount = this.notifications.filter(n => n.actionText).length;
                },
                
                applyFilters() {
                    this.filteredNotifications = this.notifications.filter(notification => {
                        const matchesType = !this.filters.type || notification.type === this.filters.type;
                        const matchesLevel = !this.filters.level || notification.level === this.filters.level;
                        const matchesStatus = !this.filters.status || notification.status === this.filters.status;
                        const matchesSearch = !this.filters.search || 
                            notification.title.toLowerCase().includes(this.filters.search.toLowerCase()) ||
                            notification.message.toLowerCase().includes(this.filters.search.toLowerCase());
                        
                        return matchesType && matchesLevel && matchesStatus && matchesSearch;
                    });
                },
                
                toggleSelectAll() {
                    if (this.selectAll) {
                        this.selectedNotifications = this.filteredNotifications.map(n => n.id);
                    } else {
                        this.selectedNotifications = [];
                    }
                },
                
                async createNotification() {
                    try {
                        const response = await fetch('/admin/api/notifications', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newNotification),
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.showCreateModal = false;
                            this.resetNewNotification();
                            this.loadNotifications();
                        }
                    } catch (error) {
                        console.error('Error creating notification:', error);
                    }
                },
                
                resetNewNotification() {
                    this.newNotification = {
                        title: '',
                        message: '',
                        type: 'SYSTEM_ALERT',
                        level: 'INFO',
                        channels: []
                    };
                },
                
                getTypeBadgeClass(type) {
                    const classes = {
                        'SYSTEM_ALERT': 'bg-blue-100 text-blue-800',
                        'BANK_TRANSFER': 'bg-green-100 text-green-800',
                        'PAYMENT_SUCCESS': 'bg-green-100 text-green-800',
                        'PAYMENT_FAILED': 'bg-red-100 text-red-800',
                        'SECURITY_ALERT': 'bg-red-100 text-red-800',
                        'PROMOTION': 'bg-purple-100 text-purple-800'
                    };
                    return classes[type] || 'bg-gray-100 text-gray-800';
                },
                
                getLevelBadgeClass(level) {
                    const classes = {
                        'LOW': 'bg-gray-100 text-gray-800',
                        'INFO': 'bg-blue-100 text-blue-800',
                        'SUCCESS': 'bg-green-100 text-green-800',
                        'WARNING': 'bg-yellow-100 text-yellow-800',
                        'ERROR': 'bg-red-100 text-red-800',
                        'CRITICAL': 'bg-red-200 text-red-900'
                    };
                    return classes[level] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusBadgeClass(status) {
                    const classes = {
                        'PENDING': 'bg-yellow-100 text-yellow-800',
                        'SENT': 'bg-blue-100 text-blue-800',
                        'DELIVERED': 'bg-green-100 text-green-800',
                        'READ': 'bg-gray-100 text-gray-800',
                        'FAILED': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },
                
                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return 'Invalid Date';
                        return date.toLocaleString();
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return 'Invalid Date';
                    }
                },
                
                getNotificationIcon(type) {
                    const iconMap = {
                        'WALLET_CREDIT': 'arrow-down',
                        'WALLET_DEBIT': 'arrow-up',
                        'BANK_TRANSACTION': 'university',
                        'BANK_TRANSFER': 'exchange-alt',
                        'ESCALATION': 'exclamation-triangle',
                        'SYSTEM_ALERT': 'bell',
                        'OTHER': 'info-circle'
                    };
                    return iconMap[type] || 'bell';
                },
                
                extractAmount(title) {
                    if (!title) return null;
                    // Try different patterns to match amounts
                    const patterns = [
                        /[₦$€£¥]\d+[.,]\d{2}/,  // Currency symbol + amount
                        /\d+[.,]\d{2}/,         // Just amount with decimal
                        /\d+/                   // Just numbers
                    ];
                    
                    for (const pattern of patterns) {
                        const match = title.match(pattern);
                        if (match) {
                            return match[0];
                        }
                    }
                    return null;
                },
                
                generateSessionId(notification) {
                    // Generate a session ID based on notification ID and timestamp
                    if (!notification.id) return 'N/A';
                    const timestamp = new Date(notification.createdAt).getTime();
                    return `000016${timestamp.toString().slice(-10)}${notification.id.toString().slice(-10)}`;
                },
                
                getRemark(notification) {
                    // Try to get remark from transaction metadata or use message as fallback
                    if (notification.transaction && notification.transaction.metadata) {
                        try {
                            const metadata = JSON.parse(notification.transaction.metadata);
                            if (metadata.remark) return metadata.remark;
                            if (metadata.description) return metadata.description;
                        } catch (e) {
                            console.warn('Failed to parse transaction metadata:', e);
                        }
                    }
                    
                    // Fallback to message or a default remark
                    if (notification.message) {
                        return notification.message;
                    }
                    
                    return `FIP:MB:PCM/${notification.recipient?.firstName || 'User'}/NOTIFICATION:${notification.type || 'ALERT'}/NONE/${notification.recipient?.firstName || 'User'}`;
                },
                
                getDisplayMessage(notification) {
                    // For display purposes, fix the message if it contains "Unknown"
                    if (notification.message && notification.message.includes('from Unknown')) {
                        const senderName = this.getSenderInfo(notification);
                        if (senderName !== 'N/A') {
                            return notification.message.replace('from Unknown', `from ${senderName}`);
                        }
                    }
                    return notification.message || 'N/A';
                },
                
                getRecipientInfo(notification) {
                    // For WALLET_DEBIT transactions, the recipient is the person who received the money
                    if (notification.type === 'WALLET_DEBIT') {
                        // Try to extract recipient from transaction description
                        if (notification.transaction && notification.transaction.description) {
                            const description = notification.transaction.description;
                            if (description.includes('Transfer to ')) {
                                const recipient = description.split('Transfer to ')[1];
                                return recipient || 'N/A';
                            }
                        }
                        
                        // Try to get from transaction metadata
                        if (notification.transaction && notification.transaction.metadata) {
                            try {
                                const metadata = JSON.parse(notification.transaction.metadata);
                                if (metadata.recipient_name) return metadata.recipient_name;
                                if (metadata.recipient_account) return metadata.recipient_account;
                            } catch (e) {
                                console.warn('Failed to parse transaction metadata for recipient:', e);
                            }
                        }
                        
                        // Fallback to message parsing
                        if (notification.message && notification.message.includes(' to ')) {
                            const parts = notification.message.split(' to ');
                            if (parts.length > 1) {
                                return parts[1].split(' was successful')[0].trim();
                            }
                        }
                    }
                    
                    // For WALLET_CREDIT transactions, the recipient is the current user
                    if (notification.type === 'WALLET_CREDIT' && notification.recipient) {
                        const firstName = notification.recipient.firstName || '';
                        const lastName = notification.recipient.lastName || '';
                        const email = notification.recipient.email || '';
                        const name = `${firstName} ${lastName}`.trim();
                        return name ? `${name} (${email})` : email || 'N/A';
                    }
                    
                    // Default fallback
                    if (notification.recipient) {
                        const firstName = notification.recipient.firstName || '';
                        const lastName = notification.recipient.lastName || '';
                        const email = notification.recipient.email || '';
                        const name = `${firstName} ${lastName}`.trim();
                        return name ? `${name} (${email})` : email || 'N/A';
                    }
                    
                    return 'N/A';
                },
                
                getSenderInfo(notification) {
                    // For WALLET_DEBIT transactions, the sender is the recipient (current user)
                    if (notification.type === 'WALLET_DEBIT' && notification.recipient) {
                        const firstName = notification.recipient.firstName || '';
                        const lastName = notification.recipient.lastName || '';
                        const email = notification.recipient.email || '';
                        const name = `${firstName} ${lastName}`.trim();
                        return name ? `${name} (${email})` : email || 'N/A';
                    }
                    
                    // For WALLET_CREDIT transactions, try to get sender from various sources
                    if (notification.type === 'WALLET_CREDIT') {
                        // First try to get from notification sender
                        if (notification.sender) {
                            const firstName = notification.sender.firstName || '';
                            const lastName = notification.sender.lastName || '';
                            const email = notification.sender.email || '';
                            const name = `${firstName} ${lastName}`.trim();
                            return name ? `${name} (${email})` : email || 'N/A';
                        }
                        
                        // Try to get from transaction metadata
                        if (notification.transaction && notification.transaction.metadata) {
                            try {
                                const metadata = JSON.parse(notification.transaction.metadata);
                                if (metadata.sender_name) return metadata.sender_name;
                                if (metadata.sender_account) return metadata.sender_account;
                            } catch (e) {
                                console.warn('Failed to parse transaction metadata for sender:', e);
                            }
                        }
                        
                        // Try to extract from message
                        if (notification.message) {
                            const message = notification.message;
                            if (message.includes('from ')) {
                                const parts = message.split('from ');
                                if (parts.length > 1) {
                                    return parts[1].split('.')[0].trim();
                                }
                            }
                        }
                    }
                    
                    // For other transaction types, try general approaches
                    if (notification.sender) {
                        const firstName = notification.sender.firstName || '';
                        const lastName = notification.sender.lastName || '';
                        const email = notification.sender.email || '';
                        const name = `${firstName} ${lastName}`.trim();
                        return name ? `${name} (${email})` : email || 'N/A';
                    }
                    
                    return 'N/A';
                },
                
                async loadStats() {
                    try {
                        const response = await fetch('/admin/api/notifications/stats', {
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.stats = data;
                        } else {
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error loading stats:', error);
                        this.calculateStats();
                    }
                },
                
                async markAllAsRead() {
                    try {
                        const response = await fetch('/admin/api/notifications/mark-all-read', {
                            method: 'POST',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications.forEach(n => n.isRead = true);
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error marking all as read:', error);
                    }
                },
                
                async deleteSelected() {
                    if (this.selectedNotifications.length === 0) return;
                    
                    try {
                        const response = await fetch('/admin/api/notifications/delete-selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids: this.selectedNotifications }),
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications = this.notifications.filter(n => !this.selectedNotifications.includes(n.id));
                            this.selectedNotifications = [];
                            this.selectAll = false;
                            this.applyFilters();
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error deleting notifications:', error);
                    }
                },
                
                async viewNotification(id) {
                    try {
                        const response = await fetch(`/admin/api/notifications/${id}`, {
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Notification data received:', result);
                            const notification = result.notification || result;
                            console.log('Notification object:', notification);
                            this.showNotificationDetails(notification);
                        } else {
                            console.error('Failed to fetch notification details');
                        }
                    } catch (error) {
                        console.error('Error fetching notification details:', error);
                    }
                },
                
                showNotificationDetails(notification) {
                    console.log('showNotificationDetails called with:', notification);
                    console.log('Title:', notification.title);
                    console.log('Message:', notification.message);
                    console.log('Type:', notification.type);
                    console.log('Level:', notification.level);
                    console.log('Status:', notification.status);
                    console.log('CreatedAt:', notification.createdAt);
                    
                    // Create a modal to show notification details
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4';
                    modal.innerHTML = `
                        <div class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <!-- Header -->
                            <div class="bg-gray-800 px-6 py-4 flex items-center justify-between rounded-t-xl">
                                <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-300">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                                <h1 class="text-white text-lg font-semibold">Notification Details</h1>
                                <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center">
                                    <i class="fas fa-bell text-white text-sm"></i>
                                </div>
                            </div>
                            
                            <!-- Notification Summary Card -->
                            <div class="bg-gray-50 mx-6 mt-6 rounded-xl p-6">
                                <div class="text-center mb-4">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i class="fas fa-${this.getNotificationIcon(notification.type)} text-blue-600 text-2xl"></i>
                                    </div>
                                    <h2 class="text-gray-800 text-lg font-medium mb-2">${notification.title || 'N/A'}</h2>
                                    <div class="text-3xl font-bold text-gray-900 mb-2">${this.extractAmount(notification.title) || 'N/A'}</div>
                                    <div class="flex items-center justify-center text-green-600">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        <span class="font-medium">${notification.status || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Information Card -->
                            <div class="bg-gray-50 mx-6 mt-4 rounded-xl p-6">
                                <h3 class="text-gray-800 text-lg font-semibold mb-4">Notification Details</h3>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Message</span>
                                        <span class="text-gray-900 text-right max-w-xs">${this.getDisplayMessage(notification)}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Type</span>
                                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${this.getTypeBadgeClass(notification.type)}">
                                            ${notification.type || 'N/A'}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Level</span>
                                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${this.getLevelBadgeClass(notification.level)}">
                                            ${notification.level || 'N/A'}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Status</span>
                                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${this.getStatusBadgeClass(notification.status)}">
                                            ${notification.status || 'N/A'}
                                        </span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Read Status</span>
                                        <span class="text-gray-900">${notification.isRead ? 'Read' : 'Unread'}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Created</span>
                                        <span class="text-gray-900">${this.formatDate(notification.createdAt)}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Session ID</span>
                                        <div class="flex items-center">
                                            <span class="text-gray-900 font-mono text-sm">${this.generateSessionId(notification)}</span>
                                            <button onclick="navigator.clipboard.writeText('${this.generateSessionId(notification)}')" class="ml-2 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-copy text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-start py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Remark</span>
                                        <span class="text-gray-900 text-right max-w-xs text-sm">${this.getRemark(notification)}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Recipient</span>
                                        <span class="text-gray-900">${this.getRecipientInfo(notification)}</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Sender</span>
                                        <span class="text-gray-900">${this.getSenderInfo(notification)}</span>
                                    </div>
                                    
                                    ${notification.transaction ? `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Transaction ID</span>
                                        <span class="text-gray-900 font-mono text-sm">${notification.transaction.id || 'N/A'}</span>
                                    </div>
                                    ` : ''}
                                    
                                    ${notification.actionUrl ? `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Action URL</span>
                                        <a href="${notification.actionUrl}" class="text-blue-600 hover:text-blue-800 text-sm truncate max-w-xs" target="_blank">
                                            ${notification.actionUrl}
                                        </a>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- More Actions Card -->
                            <div class="bg-gray-50 mx-6 mt-4 rounded-xl p-6 mb-6">
                                <h3 class="text-gray-800 text-lg font-semibold mb-4">More Actions</h3>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between py-2 hover:bg-gray-100 rounded-lg cursor-pointer">
                                        <div class="flex items-center">
                                            <i class="fas fa-copy text-gray-600 mr-3"></i>
                                            <span class="text-gray-700">Copy Notification ID</span>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                    
                                    <div class="flex items-center justify-between py-2 hover:bg-gray-100 rounded-lg cursor-pointer">
                                        <div class="flex items-center">
                                            <i class="fas fa-share text-gray-600 mr-3"></i>
                                            <span class="text-gray-700">Share Notification</span>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                    
                                    <div class="flex items-center justify-between py-2 hover:bg-gray-100 rounded-lg cursor-pointer" onclick="this.toggleReadStatus('${notification.id}'); this.closest('.fixed').remove();">
                                        <div class="flex items-center">
                                            <i class="fas fa-${notification.isRead ? 'envelope-open' : 'envelope'} text-gray-600 mr-3"></i>
                                            <span class="text-gray-700">${notification.isRead ? 'Mark as Unread' : 'Mark as Read'}</span>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                },
                
                async toggleReadStatus(id) {
                    try {
                        const response = await fetch(`/admin/api/notifications/${id}/toggle-read`, {
                            method: 'POST',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const notification = this.notifications.find(n => n.id === id);
                            if (notification) {
                                notification.isRead = result.isRead;
                                this.calculateStats();
                            }
                        } else {
                            console.error('Failed to toggle read status');
                        }
                    } catch (error) {
                        console.error('Error toggling read status:', error);
                    }
                },
                
                async deleteNotification(id) {
                    try {
                        const response = await fetch(`/admin/api/notifications/${id}`, {
                            method: 'DELETE',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            this.notifications = this.notifications.filter(n => n.id !== id);
                            this.applyFilters();
                            this.calculateStats();
                        }
                    } catch (error) {
                        console.error('Error deleting notification:', error);
                    }
                },
                
                async refreshNotifications() {
                    await this.loadNotifications();
                    await this.loadStats();
                }
            }
        }
    </script>
</div>

