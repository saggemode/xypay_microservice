<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - XyPay Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'banking-blue': '#1e40af',
                        'banking-gray': '#64748b',
                        'banking-accent': '#3b82f6'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-banking-blue text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold">XyPay Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-shield-alt mr-1"></i>ADMIN
                    </span>
                    <span class="text-sm" th:text="${#authentication.name}">Admin User</span>
                    <a href="/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">User Management</h2>
                        <p class="mt-1 text-sm text-gray-600">Manage system users, roles, and permissions</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="/admin/users/new" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200">
                            <i class="fas fa-plus mr-1"></i>Add New User
                        </a>
                        <a href="/admin/roles" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200">
                            <i class="fas fa-key mr-1"></i>Role Management
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="userSearch" class="block text-sm font-medium text-gray-700 mb-1">Search Users</label>
                        <input type="text" id="userSearch" placeholder="Username, email, or name..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-banking-blue focus:border-transparent"
                               onkeyup="filterUsers()">
                    </div>
                    <div>
                        <label for="roleFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Role</label>
                        <select id="roleFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-banking-blue focus:border-transparent" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="ROLE_SUPERUSER">Superuser</option>
                            <option value="ROLE_ADMIN">Administrator</option>
                            <option value="ROLE_TELLER">Teller</option>
                            <option value="ROLE_CUSTOMER_SERVICE_OFFICER">Customer Service Officer</option>
                            <option value="ROLE_LOAN_OFFICER">Loan Officer</option>
                            <option value="ROLE_RELATIONSHIP_MANAGER">Relationship Manager</option>
                            <option value="ROLE_OPERATIONS_OFFICER">Operations Officer</option>
                            <option value="ROLE_COMPLIANCE_OFFICER">Compliance Officer</option>
                            <option value="ROLE_TREASURY_OFFICER">Treasury Officer</option>
                            <option value="ROLE_IT_SUPPORT">IT Support</option>
                            <option value="ROLE_BRANCH_MANAGER">Branch Manager</option>
                            <option value="ROLE_OPERATIONS_MANAGER">Operations Manager</option>
                            <option value="ROLE_CHIEF_RISK_OFFICER">Chief Risk Officer</option>
                            <option value="ROLE_EXECUTIVE">Executive</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="exportUsersCSV()" class="bg-banking-blue hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200">
                            <i class="fas fa-download mr-1"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <div th:if="${users != null and #lists.size(users) > 0}">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="usersTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roles</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr th:each="user : ${users}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${user.id}">1</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${user.username}">admin</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span th:text="${user.firstName != null ? user.firstName : ''} + ' ' + ${user.lastName != null ? user.lastName : ''}">John Doe</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${user.email}">admin@xypay.com</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div th:if="${user.roles != null}">
                                            <span th:each="role, iterStat : ${#strings.listSplit(user.roles, ',')}" 
                                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-banking-blue text-white mr-1 mb-1"
                                                  th:text="${role}">ADMIN</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Active
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${user.createdAt != null ? #temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm') : 'Unknown'}">2024-01-15 09:30</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <a th:href="@{/admin/users/{id}/edit(id=${user.id})}" 
                                               class="text-banking-blue hover:text-blue-900 transition duration-200">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </a>
                                            <button onclick="viewUserDetails(this)" 
                                                    th:data-user-id="${user.id}"
                                                    th:data-username="${user.username}"
                                                    th:data-email="${user.email}"
                                                    th:data-roles="${user.roles}"
                                                    class="text-green-600 hover:text-green-900 transition duration-200">
                                                <i class="fas fa-eye mr-1"></i>View
                                            </button>
                                            <form th:action="@{/admin/users/{id}/delete(id=${user.id})}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?')">
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                <button type="submit" class="text-red-600 hover:text-red-900 transition duration-200">
                                                    <i class="fas fa-trash mr-1"></i>Delete
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Sample data when no users from backend -->
                                <tr th:if="${users == null or #lists.size(users) == 0}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">USR001</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">admin</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">System Administrator</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">admin@xypay.com</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-banking-blue text-white">ADMIN</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">2024-01-15 09:30</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <div class="flex space-x-2">
                                            <a href="/admin/users/USR001/edit" class="text-banking-blue hover:text-blue-900 transition duration-200">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </a>
                                            <button onclick="viewUserDetails(this)" 
                                                    data-user-id="USR001"
                                                    data-username="admin"
                                                    data-email="admin@xypay.com"
                                                    data-roles="ADMIN"
                                                    class="text-green-600 hover:text-green-900 transition duration-200">
                                                <i class="fas fa-eye mr-1"></i>View
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div th:if="${users == null or #lists.size(users) == 0}" class="text-center py-12 hidden" id="emptyState">
                    <i class="fas fa-users text-gray-400 text-6xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
                    <p class="text-gray-500 mb-4">Start by adding your first user to the system.</p>
                    <a href="/admin/users/new" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-200">
                        <i class="fas fa-plus mr-1"></i>Add First User
                    </a>
                </div>
            </div>
        </div>

        <!-- Back to Dashboard -->
        <div class="mt-6 text-center">
            <a href="/superuser/dashboard" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200">
                <i class="fas fa-arrow-left mr-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">User Details</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeUserModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="userDetailsBody" class="mt-2">
                    <!-- Dynamic content -->
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400" onclick="closeUserModal()">Close</button>
                    <button class="bg-banking-blue text-white px-4 py-2 rounded-md hover:bg-blue-700" onclick="editCurrentUser()">Edit User</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            const rows = document.querySelectorAll('#usersTable tbody tr');
            let visibleCount = 0;

            rows.forEach(function(row) {
                const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const name = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const email = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                const userRoles = row.querySelector('td:nth-child(5)').textContent;

                const matchesSearch = username.includes(search) || name.includes(search) || email.includes(search);
                const matchesRole = role === '' || userRoles.includes(role);

                if (matchesSearch && matchesRole) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show empty state if no results
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                if (visibleCount === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
            }
        }

        function exportUsersCSV() {
            let csv = 'ID,Username,Name,Email,Roles,Status,Created Date\n';
            const rows = document.querySelectorAll('#usersTable tbody tr');
            
            rows.forEach(function(row) {
                if (row.style.display !== 'none') {
                    const cols = row.querySelectorAll('td');
                    if (cols.length >= 7) {
                        const line = Array.from(cols.slice(0, 7)).map(td => {
                            let text = td.textContent.trim().replace(/\s+/g, ' ');
                            return '"' + text.replace(/"/g, '""') + '"';
                        }).join(',');
                        csv += line + '\n';
                    }
                }
            });

            const blob = new Blob([csv], {type: 'text/csv'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function viewUserDetails(button) {
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const email = button.getAttribute('data-email');
            const roles = button.getAttribute('data-roles');

            currentUserId = userId;

            document.getElementById('userDetailsBody').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h6 class="font-medium text-gray-900 mb-2">Basic Information</h6>
                        <p class="text-sm text-gray-600"><strong>User ID:</strong> ${userId}</p>
                        <p class="text-sm text-gray-600"><strong>Username:</strong> ${username}</p>
                        <p class="text-sm text-gray-600"><strong>Email:</strong> ${email}</p>
                    </div>
                    <div>
                        <h6 class="font-medium text-gray-900 mb-2">Roles & Permissions</h6>
                        <p class="text-sm text-gray-600"><strong>Assigned Roles:</strong></p>
                        <div class="mt-1">
                            ${roles ? roles.split(',').map(role => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-banking-blue text-white mr-1 mb-1">${role.trim()}</span>`).join('') : 'No roles assigned'}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('userDetailsModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            currentUserId = null;
        }

        function editCurrentUser() {
            if (currentUserId) {
                window.location.href = `/admin/users/${currentUserId}/edit`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Any initialization code can go here
        });
    </script>
</body>
</html>
